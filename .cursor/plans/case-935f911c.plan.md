<!-- 935f911c-6720-49eb-8cdf-46060ab3d7f5 9b75b9e9-a53e-4ffb-ba74-c320f5f8020f -->
# Fix Dev CSP Lockout

## Problem

The dev server runs on port 5001, but the CSP middleware may be applying production-level restrictions or incorrect localhost URLs, causing the browser to block Vite's scripts and resulting in a white screen.

## Solution

Verify the CSP is correctly relaxed for development and includes the correct port (5001).

## Steps

### 1. Verify Current CSP Configuration

**File**: `server/middleware/security-headers.ts` (lines 40-61)

Check that:

- The `!isProd` block correctly reads `env.PORT` (should be 5001)
- Dev CSP includes `'unsafe-inline'` and `'unsafe-eval'` for script-src
- WebSocket origin (`ws://localhost:5001`) is in connect-src

**Expected**: The dev CSP should already be set up correctly based on current code.

### 2. Test in Browser

- Navigate to `http://localhost:5001`
- Open Chrome DevTools Console (Cmd+Option+J)
- Look for:
  - CSP errors (e.g., "Refused to execute inline script")
  - Network errors (failed to load `/@vite/client` or similar)
  - SSL/certificate errors

### 3. Apply Fix (If Needed)

**Most likely issue**: The CSP check on line 40 (`if (!isProd)`) may not be triggering correctly.

**Fix**: Ensure `isProduction` from `env.ts` correctly evaluates `NODE_ENV`. The terminal shows `NODE_ENV=development` is set, so this should work.

**Alternative fix**: If CSP is still blocking, temporarily disable CSP entirely in dev by returning early:

```typescript
if (!isProd) {
  return next(); // Skip all CSP headers in development
}
```

This is the nuclear option but guarantees no CSP lockout.

### 4. Document the Resolution

Update `README.md` or create `docs/DEV_SETUP.md` with:

- Correct dev server URL: `http://localhost:5001`
- Note that CSP is relaxed in development
- If Redis warnings appear, note they can be ignored for local dev

## Files to Touch

**Primary**: `server/middleware/security-headers.ts` (1-5 line change max)

**Documentation**: `README.md` or new `docs/DEV_SETUP.md`

**Off-Limits**: Do NOT touch `routes.ts`, `schema.ts`, or any React components. This is purely a server headers issue.

## Success Criteria

1. Navigate to `http://localhost:5001` and see the React app load (no white screen)
2. No CSP errors in browser console
3. Vite HMR (hot module reload) works when editing files

### To-dos

- [x] Create database migration for case_study_content column
- [x] Update Drizzle ORM definition in shared/schema.ts
- [x] Create validateRequest middleware in server/middleware/validation.ts
- [x] Define Zod schemas for Case Study blocks in shared/schema.ts
- [x] Implement PATCH and update GET routes in server/routes.ts
- [ ] Create shared/case-study-schema.ts
- [x] Run case study content migration
- [x] Add /api/branding projects read endpoints
- [ ] Update branding page data fetching
- [ ] Add color utils file with getContrastColor/applyTheme
- [ ] Create CaseStudyWrapper component
- [ ] Extend Tailwind colors with brand CSS vars
- [x] Add color utils file with getContrastColor/applyTheme
- [x] Create CaseStudyWrapper component
- [x] Extend Tailwind colors with brand CSS vars
- [ ] Add color utils file with getContrastColor/applyTheme
- [ ] Create CaseStudyWrapper component
- [ ] Extend Tailwind colors with brand CSS vars
- [ ] Add color utils file with getContrastColor/applyTheme
- [ ] Create CaseStudyWrapper component
- [ ] Extend Tailwind colors with brand CSS vars
- [ ] Add color utils file with getContrastColor/applyTheme
- [ ] Create CaseStudyWrapper component
- [ ] Extend Tailwind colors with brand CSS vars
- [x] Create database migration for case_study_content column
- [x] Update Drizzle ORM definition in shared/schema.ts
- [x] Create validateRequest middleware in server/middleware/validation.ts
- [x] Define Zod schemas for Case Study blocks in shared/schema.ts
- [x] Implement PATCH and update GET routes in server/routes.ts
- [x] Run case study content migration
- [x] Add /api/branding projects read endpoints
- [x] Add color utils file with getContrastColor/applyTheme
- [x] Create CaseStudyWrapper component
- [x] Extend Tailwind colors with brand CSS vars